<!DOCTYPE html>

<html lang="en">

<head>

	<meta charset="UTF-8">

	<title>firebase測試</title>

  <style type="text/css">

    *{
      padding: 0;
      margin: 0;
    }

    body{
      background-image: url("img/wallpaper.jpg");
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      background-size: cover;
      /*position: relative;*/
    }

    td /*設定表格文字左右和上下居中對齊*/
    {
      vertical-align: middle;
      text-align: center;
      padding: 9px;
    }

    img{

    display: block;

    width: 50%;

    height: 50%;

    object-fit:cover;

    margin: auto;

    opacity: 0.8;

    }
    form{
    font-family: 微軟正黑體; 
      
    font-size:20px;
      
    color: white;
    }
    .web{
      
    width: 1000px;
    margin: auto;
    display: flex;
      
    }

    /*@media screen and (max-width: 1000px){
      .web{
           width: 100vw;
         }
    }*/
      
    .information{
    width: 460px;
    margin: 0 20px;
    }

    .data{
      width: 500px;
        }

    #infor{
      border:2px solid #000; 
      font-family: 微軟正黑體; 
      font-size:16px; 
      text-align:center;
      width: 100%;
      border-collapse:collapse;
      display: none;
      margin: 10px 0px 10px 0px;

    }

    #infor th{ 
      background-color: #009FCC;
      padding:10px;
      border:1px solid #000;
      color:#fff;
    } 
    #infor td{ 
      border:1px solid #000;
      padding:5px;
      color:#130f40;
    }

    #tab{
      border:2px solid #000; 
      font-family: 微軟正黑體; 
      font-size:16px; 
      width:498px;
      text-align:center;
      border-collapse:collapse;
    }

    #tab th{ 
      background-color: #009FCC;
      padding:10px;
      border:1px solid #000;
      color:#fff;
    } 
    #tab td{ 
      border:1px solid #000;
      padding:5px;
    } 

    .chart{
      display: flex;
      width: 1000px;
      margin: 0 auto;
    }

    .bar{
      width: 490px;
      margin: auto;}

    .pie{
      width: 490px;
      margin: auto;}

    hr{
    border: 0;
    height: 1px;
    background: #333;
    background-image: linear-gradient(to right, #ccc, #333, #ccc);
    }

    tr th{
      color: #D7FFEE;
    }

    .userID{
            display: none;
          }

    .LogOut{
            display: none;
          }

    .footer{
      text-align: center;
      background-color: #000;
      color: #aaa;
      font-size: 16px;
      position: absolute;
      left: 0;
      right: 0;
      width:100%;
    }


  </style>



</head>

<!-- html -->

<body> <!-- 顯示時間攔位 -->

<!-- chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

<!-- JQuery -->
<script src="js/jquery.min.js"></script>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<img src="img/Logo.jpg" alt="博通生技">

<hr> <!-- 水平線 -->

<br>

<div class="web">
  
<div class="information">

<form>

<p class="userID"></p>

<div class="userdata">
  
<div class= "form-group userdata">

<label for="exampleInputEmail1">Email address</label>
  
<input id="mail" class="form-control" aria-describedby="emailHelp" type="email" placeholder="請輸入完整的Email帳號">

</div>

<div class="form-group userdata">

<label for="exampleInputPassword1">Password</label>

<input id="password" class="form-control" type="password" placeholder="6個含以上的英文及數字">


</div>

</div>

<input class="sig btn btn-primary" type="button" value="註冊帳號" onclick="sig()">

<!-- <input class="check btn btn-primary" type="button" value="確認帳號" onclick="check()"> -->

<input class="LogIn btn btn-primary" type="button" value="登入" onclick="LogIn()">

<input class="LogOut btn btn-primary" type="button" value="登出帳號" onclick="LogOut()">

<input class ="GM btn btn-primary"type="button" value="管理者模式" onclick="GMmode()">

<table id="infor">

<tr>

<th>User id</th>

<th>Password</th>

<th>button</th>

</tr>
        
</table>

<div class="form-group">
  <label for="project">Project Name</label>
  <input type="text" class="form-control" id="PName">
</div>
<div class="form-group">
  <label for="test value">Test Value</label>
  <input type="text" class="form-control" id="tvalue">
</div>
<div class="form-group">
  <label for="description">Description</label>
  <textarea id="desctip" class="form-control" rows="3" placeholder="請輸入產品敘述"></textarea>
</div>
<div class="form-group">
  <label for="creator">Creator</label>
  <input type="text" class="form-control" id="creator">
</div>

<input class="btn btn-primary" type="button" value="寫入資料" onclick="storedata()">

<input class="btn btn-primary" type="button" value="讀取資料" onclick="getdata()">


</form>

</div>

 <br>

<div class="data">

<table id="tab">

<tr>

<th>Project Name</th>

<th>Glu</th>

<th>Desctiption</th>

<th>creatorors</th>

<th>Delete</th>

</tr>
        
</table>

</div>

</div>

<pre class="test"></pre>


<!--引入firebase SDK函式庫 -->

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>

<!--引入firestore SDK函式庫 -->
<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>




<script>
//網頁應用程式碼

var firebaseConfig = {
    apiKey: "AIzaSyBAEfHCPVeRoj_taVdUGoHmgJjNtdgIS5U",
    authDomain: "test-web-bc0d7.firebaseapp.com",
    databaseURL: "https://test-web-bc0d7.firebaseio.com",
    projectId: "test-web-bc0d7",
    storageBucket: "test-web-bc0d7.appspot.com",
    messagingSenderId: "126589548464",
    appId: "1:126589548464:web:4326ceef2d4070c1fe0875",
    measurementId: "G-FSR7JRVDNZ"
  };

  //初始化firebase
  firebase.initializeApp(firebaseConfig);

  var database = firebase.database();


  //分析firebase
  firebase.analytics();
 
  //設定變數db存放firebase.firestore()
  var db = firebase.firestore();


  //帳號登入中的狀態和登出的判別


  //修正boostrap未隱藏問題
  $(".LogOut").css("display", "none");

  //確認目前登入帳號，測試用
  function check(){

    var user = firebase.auth().currentUser; //確認當前用戶

      if(user){

      alert("目前登入中~")

      console.log(user.email);

      }
                      
      else{
      //確認目前登入帳號
      // console.log(JSON.parse(JSON.stringify(user.email)));
      alert("沒有人在家哦");
      } 

  }

  //管理者模式認證

  function GMmode(){

    //取得當前用戶的email
    var email = $('#mail').val();

    //取得當前用戶的password
    var password = $('#password').val();

    //驗證碼
    var passcode1 = "dHVuYTAzMjBAZ21haWwuY29tLnR3";

    var passcode2 = "MzIwMzIwbg==";

    var encodeStr1 = encode(email);

    var encodeStr2 = encode(password);

    function encode(str) {

    return btoa(str); //將字串轉換

    }

    if(encodeStr1 === passcode1 && encodeStr2 === passcode2){

       alert("歡迎你，志學");

       $(".LogIn, .sig").hide();

       $(".LogOut").show();

       //介面功能
       $("#infor").show(); //顯示隱藏的表格

       reset(infor); //表格reset以防重覆顯示

       firebase.auth().signInWithEmailAndPassword(email, password).then(function(){

        alert("登入成功!!");

        //登入成功時隱藏登入、註冊、輸入介面
        $(".LogIn, .sig, .userdata").hide();

        $(".userID").css("display", "block");

        $(".userID").append("歡迎您&nbsp;" + email);

        $(".LogOut").show();

        }).catch(function(error) {

        // Handle Errors here.

        alert("登入失敗!! 請檢查帳號密碼是否正確");

        var errorCode = error.code;

        var errorMessage = error.message;

        console.log(errorCode);

        console.log(errorMessage);

        // ...

        });

       var ref = db.collection('profiles').get().then(result => {
    
        result.forEach(doc => {

        var userID = doc.data().userid;
        var userPW = doc.data().userpw;
        
        //自動新增表單

        var infor = document.getElementById('infor');
        
        for(var i = 0; i < 1; i++){
        
        infor.innerHTML+='<table>' + '<tr style="background: #C4E1E1">' + '<td>' + doc.data().userid + '</td>' + '<td>' + doc.data().userpw + '</td>' + '<td>' + '<button onclick = "delUser(this);" class = "btn btn-info">' + '刪除' + '</button>' + '</td>' + '</tr>' + '</table>'; 
        }
        
        });

        
        alert("資料讀取完成!!");
        
        }).catch(err => {
        console.log('Error getting documents', err);
        alert("資料讀取失敗!!")
        });
    }

    else{
         alert("此功能只供管理員使用!!");
    }
  }



  //帳號密碼註冊
  function sig() {

  //取得帳號密碼輸入欄位的值
  var email = $('#mail').val();

  var password = $('#password').val();

  //Regular Expression 的語法確認用設定，前後用//包起來
  var emailRule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;

  //6個含以上的英文及數字，不可包含其他字元
  var passRule = /(?!^[0-9]{6,}$)(?!^[a-zA-Z]{6,}$)^[0-9a-zA-Z]{6,}$/;

  //判斷帳號、密碼格式
  if(email.search(emailRule)!= -1){

        if(password.search(passRule)!= -1){

        firebase.auth().createUserWithEmailAndPassword(email, password);

        db.collection("profiles").doc(email).set({ 
        //文件裡的集合
        
        userid: email,
        
        userpw: password
        
        }); 

        console.log(email, password);

        alert('註冊成功!!');

        //註冊成功後清空錯誤訊息顏色
        $("#mail, #password").css("background", "#ffffff");

        //清除上一筆註冊資料
        $("#mail, #password").val("");

        }

        else{

        $("#mail, #password").css("background", "#ffffff");

        alert('密碼輸入錯誤,必須包含 6 個(含)以上的英文及數字\n且不能包含英數字以外的字元');

        $("#password").css("background", "#ff6b81");

        }
     }

  else{
      
      alert('帳號輸入錯誤,必須為電子郵件格式且不能包含英數字以外的字元');

      $("#mail").css("background", "#ff6b81");
  
  }
}

  //帳號登入
  function LogIn(){

    //取得帳號密碼輸入欄位的值
    var email = $('#mail').val();
      
    var password = $('#password').val();


    //驗證auth的帳號密碼，並顯示登入成功與失敗的畫面

    firebase.auth().signInWithEmailAndPassword(email, password).then(function(){

    alert("登入成功!!");

    //登入成功時隱藏登入、註冊、輸入介面
    $(".LogIn, .sig, .userdata").hide();

    $(".userID").css("display", "block");

    $(".userID").append("歡迎您&nbsp;" + email);

    $(".LogOut").show();

    }).catch(function(error) {

    // Handle Errors here.

    alert("登入失敗!! 請檢查帳號密碼是否正確");

    var errorCode = error.code;

    var errorMessage = error.message;

    console.log(errorCode);

    console.log(errorMessage);

    // ...

    });

}

  //帳號登出              
  function LogOut(){

    firebase.auth().signOut().then(function() {

    alert('您已登出成功~');

    $(".LogIn, .sig, .userdata").show();

    $(".LogOut").css("display", "none");

    $(".userID").css("display", "none");

    $(".userID").empty();

    //登出後將帳號密碼欄位清空
    $("#mail, #password").val("");

    $("#infor").hide();

    //log顯示Null即為登出
    var user = firebase.auth().currentUser;

    console.log(user);

    })

  }

  // function LoadUserData(){
  //                         }

  //新增資料
  function storedata() {

    //取得文字輸入框的值
    var PName = document.getElementById('PName').value;
    var tvalue = document.getElementById('tvalue').value;
    var desctip = document.getElementById('desctip').value;
    var creator = document.getElementById('creator').value;

    //防止客戶遺漏key in 
    if (PName === "" || tvalue === "" || desctip === "" || creator === "") {

          if (PName ==="") {
            $("#PName").css("background", "#ff6b81");
          }
          if (tvalue ==="") {
            $("#tvalue").css("background", "#ff6b81");
          }
          if (desctip ==="") {
            $("#desctip").css("background", "#ff6b81");
          }
          if (creator ==="") {
            $("#creator").css("background", "#ff6b81");
          }


          alert("您有還沒填寫的資料!!");
    
    //驗證輸入欄位是否為數字和小數點
    }else if(tvalue != tvalue.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,)){ 

      alert("請您填寫正確的測試數值!!");

      //Jquery新增HTML DOM的CSS，提示使用者哪裡錯誤

      $("#tvalue").css("background", "#ff6b81");
    }

    else{

    db.collection("biotech").doc(PName).set({

    //文件裡的集合

    Projectname: PName,

    Glu: tvalue,

    Desctiption:desctip,

    creator: [creator]

    });

    //輸入成功時刷新輸入錯位置的CSS
    $("#PName, #tvalue, #desctip, #creator").css("background", "#ffffff");

    alert("資料新增完成!! 請重新讀取表格");

    }
  }


  //讀取資料
 function getdata() {

  //清空目前表格(以防資料重疊)
  reset(tab);

  var ref = db.collection('biotech').get().then(result => {
    
    result.forEach(doc => {

        var Name = doc.data().Projectname;
        var sn = doc.data().Glu;
        var desctiption = doc.data().Desctiption;
        var creator = doc.data().creator;
        

        // console.log(Name);


        //自動新增表單

        var tab = document.getElementById('tab');

        for(var i = 0; i < 1; i++){

        tab.innerHTML+='<table>' + '<tr style="background: #C4E1E1">' + '<td>' + doc.data().Projectname + '</td>' + '<td>' + doc.data().Glu + '</td>' + '<td>' + doc.data().Desctiption + '</td>' + '<td>' + doc.data().creator + '</td>' + '<td>' + '<button onclick = "del(this);" class = "btn btn-info">' + '刪除' + '</button>' + '</td>' + '</tr>' + '</table>'; 
        }

    });

    alert("資料讀取完成!!");

    //表格重新繪製，避免重複
    $("#myChart").remove();

    $(".bar").append('<canvas id="myChart" width="490" height="500"></canvas>');


    //長條圖
    var ctx = $("#myChart");

    Chart.defaults.global.defaultFontColor = 'white'; //標示文字顏色

    Chart.defaults.global.defaultFontSize = 20; //字體大小

    var myChart = new Chart(ctx, {

    type: 'bar', //圖表類型
    data: {     
        labels: [], //圖表顯示資料標籤
        datasets: [{ //圖表資料是一個array
            label: [null],
            data: [], //資料數值
            backgroundColor: [], 
            borderColor: [],
            borderWidth: 3,
            hoverBackgroundColor: [],
            hoverBorderColor:[]

        }]
    },
    options: { //圖表設定  
        // events: ['mousemove'],       
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
          }
        }
      });

        //for 迴圈控制讀取表格資料

        //取得表格的tr數量帶進j作計算

        //Labels顯示產品名稱

        var pname = [];

        var glu = [];

        var color = ['rgba(126, 214, 223, 0.5)'];

        var bcolor = ['rgba(126, 214, 223, 1.0)'];

        var hbgc = ['rgba(126, 214, 223, 0.5)'];

        var hbc = ['rgba(246, 229, 141,1.0)'];

        var row = document.getElementById("tab").rows.length;  //抓取table的列數


        //清空各欄位資料，以防資料殘留



        //圖表標籤
        for(var j = 1; j < row; j++) //因為索引0是th，所以從1開始
        {
          
          pname = $("#tab").find("tr").eq(j).children("td").eq(0).text(); //尋找tr的子元素td裡的文字內容

          glu = $("#tab").find("tr").eq(j).children("td").eq(1).text();

          myChart.data.labels.push(pname); //新增labels字串內容

          myChart.data.datasets.forEach((datasets) => { 

          datasets.data.push(glu);//新增data字串內容

          //色彩設定
          datasets.backgroundColor.push(color);

          datasets.borderColor.push(bcolor); 

          datasets.hoverBackgroundColor.push(hbgc);

          datasets.hoverBorderColor.push(hbc);

          });

          myChart.update(); //更新myChart內容
          
          console.log(pname);

          console.log(glu);

          console.log(color);

          console.log(bcolor);

        }

  })

  .catch(err => {
    console.log('Error getting documents', err);
    alert("資料讀取失敗!!")
  });

}

  //清除表格
  function reset(item){

      if(item === tab){

          var rowNum = tab.rows.length;
      
           for (i = 0; i < rowNum; i++)
           {
               tab.deleteRow(i);
      
               rowNum = rowNum - 1;
      
               i = i - 1;
           }
      
      tab.innerHTML ='<table>' +'<tr>' + '<th>' +'Project Name'+ '</th>' + '<th>' +'Glu'+ '</th>' + '<th>' +'Desctiption'+ '</th>' + '<th>' + 'creatorors' + '</th>' + '<th>' + 'Delete' + '</th>' + '</tr>' + '</table>';
      }

      else if(item === infor){

          var rowNum = infor.rows.length;
      
           for (i = 0; i < rowNum; i++)
           {
               infor.deleteRow(i);
      
               rowNum = rowNum - 1;
      
               i = i - 1;
           }
      
      infor.innerHTML ='<table>' +'<tr>' + '<th>' +'User id'+ '</th>' + '<th>' +'Password'+ '</th>' + '<th>' +'button'+ '</th>' + '</tr>' + '</table>';
    }

      else{
           alert("母湯哦!!");
         }
    
 }

  
  //刪除資料
     function del(obj){

        //取得table裡的目標列數

        var x = $(obj).parent().parent().find("td"); //取得botton父元素位置--> <td> --> <tr>再尋找<td>

        var msg = x.eq(0).text(); //從<tr>開始搜尋<td>，指定x的第0列內容

        var user = firebase.auth().currentUser; //取得當前登入者資訊

        //刪除資料的密碼依照登入者的密碼設定
        var pw = $("#password").val();
        
        //確認是否刪除按鈕 co0nfirm

        //prompt() 執行後會返回使用者輸入的字串 (或得到空字串)，如果使用者按取消按鈕則會返回 null

        var passID = prompt("請輸入密碼");

        // var encodeStr = encode(passID);

        // function encode(str) {

        // return btoa(str); //字串轉換

        // }

        if(confirm("確實要刪除"+ " " + msg + " " + "嗎?") && pw === passID){

        //確實可以刪除行列取得的值
        db.collection("biotech").doc(msg).delete().then(function() {

        console.log("Document successfully deleted!");

        alert("表格刪除成功!!");

        getdata();

        }).catch(function(error) {

        console.error("Error removing document: ", error);

       });

      }
    
        else{

          alert("由於密碼錯誤或其他因素，已取消了刪除操作");

      }
    }

    function delUser(user){

        //取得table裡的目標列數

        var x = $(user).parent().parent().find("td"); //取得botton父元素位置--> <td> --> <tr>再尋找<td>

        var msg = x.eq(0).text(); //從<tr>開始搜尋<td>，指定x的第0列內容

        
        //確認是否刪除按鈕 co0nfirm

        if(confirm("確實要刪除"+ " " + msg + " " + "嗎???")){

        //確實可以刪除行列取得的值
        db.collection("profiles").doc(msg).delete().then(function() {

        console.log("Document successfully deleted!");

        alert("表格刪除成功!!");

        // getdata();

        }).catch(function(error) {

        console.error("Error removing document: ", error);

       });

      }
    
        else{

          alert("已經取消了刪除操作");

          event.preventDefault(); //取消自動重整的問題事件

      }
    }

</script>

<!-- 圖表 -->

<div class="chart">
  
  <div class="bar"> <!-- 柱狀圖 -->
  
  <canvas id="myChart" width="490" height="500"></canvas>

<script>

// var ref = db.collection('biotech').get().then(result => {
    
//   result.forEach(doc => {

//     var Name = doc.data().Projectname;
//     var sn = doc.data().Glu;
//     var desctiption = doc.data().Desctiption;
//     var creator = doc.data().creator;

//     });
//   });

</script>

</div>

<div class="pie"> <!-- 圓餅圖 -->
  
  <canvas id="myChart1" width="490" height="500"></canvas>

<script>
var ctx = $("#myChart1");

Chart.defaults.global.defaultFontColor = 'white'; //標示文字顏色

Chart.defaults.global.defaultFontSize = 20; //字體大小

var myChart = new Chart(ctx, {
    type: 'pie', //圖表類型
    data: {     
        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
        datasets: [{
            // label: "測試值",
            data: [10, 20, 30, 40, 50, 60],
            backgroundColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 3
            
        }]
    },
    options: {        
        scales: {
        }
    }
});
</script>

</div>

</div>

<div class="footer">
    &copy; copyright 2020.12.25 by Tuna
</div>

</body>

</html>