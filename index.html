<!DOCTYPE html>

<html lang="en">

<head>

	<meta charset="UTF-8">

	<title>firebase測試</title>

  <style type="text/css">

    body{
      background-image: url(img/wallpaper.jpg);
      background-repeat: round;
    }

    td /*設定表格文字左右和上下居中對齊*/
    {
      vertical-align: middle;
      text-align: center;
      padding: 9px;
    }

    textarea{
      min-height: 60px;
      min-width: 200px;
    }

    img{

    display: block;

    width: 50%;

    height: 50%;

    object-fit:cover;

    margin: auto;

    opacity: 0.8;

    }
    
    .web{

      width: 1000px;
      margin: auto;
      display: flex;

    }

    .information{
      width: 460px;
      margin: 0 20px;
    }

    .data{
      width: 460px;
      margin: 0 20px;
        }

    .chart{
      display: flex;
      width: 1000px;
      margin: 0 auto;
    }

    .bar{
      width: 490px;
      margin: 0 5px;}

    .pie{
      width: 490px;
      margin: 0 5px;}

    hr{
    border: 0;
    height: 1px;
    background: #333;
    background-image: linear-gradient(to right, #ccc, #333, #ccc);
    }

    tr th{
      color: #D7FFEE;
    }


  </style>



</head>

<!-- html -->

<body> <!-- 顯示時間攔位 -->

<!-- chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

<!-- JQuery -->
<script src="js/jquery.min.js"></script>

<img src="img/Logo.jpg" alt="博通生技">

<hr> <!-- 水平線 -->

<br>

<div class="web">
  
<div class="infomation">

<form>


輸入帳號 : <input id="mail" type="email">

<br><br>

輸入密碼 : <input id="password" type="password">

<br><br>

<button onclick ="sig()">註冊</button>

<br><br>

產品名稱 : <input id = PName type="text">

<br><br>

請輸入Glu : <input id = tvalue type="tel">

<br><br>

產品描述: <textarea id = desctip cols = "50" rows = "5" placeholder="請輸入產品敘述"></textarea>

<br><br>

測試人員: <input id = creator type="text">

<input type="button" value="寫入資料" onclick="storedata()">

<input type="button" value="讀取資料" onclick="getdata()">


</form>

</div>

 <br>

<!--按鈕觸發storedata function-->
<div class="data">
  
<!-- <button onclick="storedata()"> 寫入資料</button> -->

<!-- <button onclick="getdata()">讀取表格</button> -->

<table id="tab" style="border:3px #FFD382 dashed;" cellpadding="10" border="1">

<tr>

<th>Project Name</th>

<th>Glu</th>

<th>Desctiption</th>

<th>creatorors</th>

<th>Delete</th>

</tr>
        
</table>

</div>

</div>

<pre class="test"></pre>


<!--引入firebase SDK函式庫 -->

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>

<!--引入firestore SDK函式庫 -->
<script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>




<script>
	
  //網頁應用程式碼

var firebaseConfig = {
    apiKey: "AIzaSyBAEfHCPVeRoj_taVdUGoHmgJjNtdgIS5U",
    authDomain: "test-web-bc0d7.firebaseapp.com",
    databaseURL: "https://test-web-bc0d7.firebaseio.com",
    projectId: "test-web-bc0d7",
    storageBucket: "test-web-bc0d7.appspot.com",
    messagingSenderId: "126589548464",
    appId: "1:126589548464:web:4326ceef2d4070c1fe0875",
    measurementId: "G-FSR7JRVDNZ"
  };

  //初始化firebase
  firebase.initializeApp(firebaseConfig);

  var database = firebase.database();


  //分析firebase
  firebase.analytics();
 

  //設定變數db存放firebase.firestore()
  var db = firebase.firestore();


  //新增資料
  function storedata() {

    //取得文字輸入框的值
    var PName = document.getElementById('PName').value;
    var tvalue = document.getElementById('tvalue').value;
    var desctip = document.getElementById('desctip').value;
    var creator = document.getElementById('creator').value;

    //防止客戶遺漏key in 
    if (PName === "" || tvalue === "" || desctip === "" || creator === "") {

          if (PName ==="") {
            $("#PName").css("background", "#ff6b81");
          }
          if (tvalue ==="") {
            $("#tvalue").css("background", "#ff6b81");
          }
          if (desctip ==="") {
            $("#desctip").css("background", "#ff6b81");
          }
          if (creator ==="") {
            $("#creator").css("background", "#ff6b81");
          }


          alert("您有還沒填寫的資料!!");
    
    //驗證輸入欄位是否為數字和小數點
    }else if(tvalue != tvalue.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,)){ 

      alert("請您填寫正確的測試數值!!");

      //Jquery新增HTML DOM的CSS，提示使用者哪裡錯誤

      $("#tvalue").css("background", "#ff6b81");
    }

    else{

    db.collection("biotech").doc(PName).set({

    //文件裡的集合

    Projectname: PName,

    Glu: tvalue,

    Desctiption:desctip,

    creator: [creator]

    });

    //輸入成功時刷新輸入錯位置的CSS
    $("#PName, #tvalue, #desctip, #creator").css("background", "#ffffff");

    alert("資料新增完成!! 請重新讀取表格");

    }
  }


  //讀取資料
 function getdata() {

  //清空目前表格(以防資料重疊)
  reset();

  var ref = db.collection('biotech').get().then(result => {
    
    result.forEach(doc => {

        var Name = doc.data().Projectname;
        var sn = doc.data().Glu;
        var desctiption = doc.data().Desctiption;
        var creator = doc.data().creator;
        

        // console.log(Name);


        //自動新增表單

        var tab = document.getElementById('tab');

        for(var i = 0; i < 1; i++){

        tab.innerHTML+='<table>' + '<tr style="background: #C4E1E1">' + '<td>' + doc.data().Projectname + '</td>' + '<td>' + doc.data().Glu + '</td>' + '<td id>' + doc.data().Desctiption + '</td>' + '<td>' + doc.data().creator + '</td>' + '<td>' + '<button onclick = "del(this);" class = "btn">' + '刪除' + '</button>' + '</td>' + '</tr>' + '</tablr>'; 
        }

        //搜尋不要放這，表格剛建立完會來不及抓



    });

    alert("資料讀取完成!!");

    $("#myChart").remove();

    $(".bar").append('<canvas id="myChart" width="490" height="500"></canvas>');


    //長條圖
    var ctx = $("#myChart");

    Chart.defaults.global.defaultFontColor = 'white'; //標示文字顏色

    Chart.defaults.global.defaultFontSize = 20; //字體大小

    var myChart = new Chart(ctx, {

    type: 'bar', //圖表類型
    data: {     
        labels: [], //圖表顯示資料標籤
        datasets: [{ //圖表資料是一個array
            label: [null],
            data: [], //資料數值
            backgroundColor: [], 
            borderColor: [],
            borderWidth: 3,
            hoverBackgroundColor: [],
            hoverBorderColor:[]

        }]
    },
    options: { //圖表設定  
        // events: ['mousemove'],       
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
          }
        }
      });

        //for 迴圈控制讀取表格資料

        //取得表格的tr數量帶進j作計算

        //Labels顯示產品名稱

        var pname = [];

        var glu = [];

        var color = ['rgba(126, 214, 223, 0.5)'];

        var bcolor = ['rgba(126, 214, 223, 1.0)'];

        var hbgc = ['rgba(126, 214, 223, 0.5)'];

        var hbc = ['rgba(246, 229, 141,1.0)']

        var row = document.getElementById("tab").rows.length;  //抓取table的列數


        //清空各欄位資料，以防資料殘留



        //圖表標籤
        for(var j = 1; j < row; j++) //因為索引0是th，所以從1開始
        {
          
          pname = $("#tab").find("tr").eq(j).children("td").eq(0).text(); //尋找tr的子元素td裡的文字內容

          glu = $("#tab").find("tr").eq(j).children("td").eq(1).text();

          myChart.data.labels.push(pname); //新增labels字串內容

          myChart.data.datasets.forEach((datasets) => { 

          datasets.data.push(glu);//新增data字串內容

          //色彩設定
          datasets.backgroundColor.push(color);

          datasets.borderColor.push(bcolor); 

          datasets.hoverBackgroundColor.push(hbgc);

          datasets.hoverBorderColor.push(hbc);

          });

          myChart.update(); //更新myChart內容
          
          console.log(pname);

          console.log(glu);

          console.log(color);

          console.log(bcolor);

        }

       //色彩配置

       // for(let l = 1; l < row; l++)
       // {

       //   myChart.data.datasets.forEach((datasets) => { //新增data字串內容

       //   datasets.backgroundColor.push(color);

       //   datasets.borderColor.push(bcolor); 

       //   datasets.hoverBackgroundColor.push(hbgc);

       //   datasets.hoverBorderColor.push(hbc);

       //   });

       //   myChart.update();
          
       //   console.log(color);

       //   console.log(bcolor);

       // }





  })

  .catch(err => {
    console.log('Error getting documents', err);
    alert("資料讀取失敗!!")
  });

}

  //帳號密碼註冊
  function sig() {

  var email = document.getElementById('mail').value;

  var password = document.getElementById('password').value;

  firebase.auth().createUserWithEmailAndPassword(email, password);
}

  //清除表格
  function reset(){

    var rowNum = tab.rows.length;

     for (i = 0; i < rowNum; i++)
     {
         tab.deleteRow(i);

         rowNum = rowNum - 1;

         i = i - 1;
     }

    tab.innerHTML ='<table>' +'<tr style="border:3px #FFD382 dashed;" cellpadding="10" border="1">' + '<th>' +'Project Name'+ '</th>' + '<th>' +'Glu'+ '</th>' + '<th>' +'Desctiption'+ '</th>' + '<th>' + 'creatorors' + '</th>' + '<th>' + 'Delete' + '</th>' + '</tr>' + '</table>';
 

}

  
  //刪除資料
     function del(obj){

        //取得table裡的目標列數

        var table = $("#tab");

        var x = $(obj).parent().parent().find("td"); //取得botton父元素位置--> <td> --> <tr>再尋找<td>

        var msg = x.eq(0).text(); //從<tr>開始搜尋<td>，指定x的第0列內容
        
        //確認是否刪除按鈕 co0nfirm

        if(confirm("確實要刪除"+ " " + msg + " " + "嗎?")){

        //確實可以刪除行列取得的值
        db.collection("biotech").doc(msg).delete().then(function() {

        console.log("Document successfully deleted!");

        alert("表格刪除成功!!");

        getdata();

        }).catch(function(error) {

        console.error("Error removing document: ", error);

       });

      }
    
        else{

          alert("已經取消了刪除操作");

          // var y = $("#tab").find("td").eq(0).text();//EG153
      }


    }

        
      
    

//顯示資料
console.log("初始化成功!");


</script>

<!-- 圖表 -->



<div class="chart">
  
  <div class="bar"> <!-- 柱狀圖 -->
  
  <canvas id="myChart" width="490" height="500"></canvas>

<script>

var ref = db.collection('biotech').get().then(result => {
    
  result.forEach(doc => {

    var Name = doc.data().Projectname;
    var sn = doc.data().Glu;
    var desctiption = doc.data().Desctiption;
    var creator = doc.data().creator;
    var len = ('A').length; //指定誰當for迴圈次數判別

    });
  });

</script>

</div>

<div class="pie"> <!-- 圓餅圖 -->
  
  <canvas id="myChart1" width="490" height="500"></canvas>

<script>
var ctx = $("#myChart1");

Chart.defaults.global.defaultFontColor = 'white'; //標示文字顏色

Chart.defaults.global.defaultFontSize = 20; //字體大小

var myChart = new Chart(ctx, {
    type: 'pie', //圖表類型
    data: {     
        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
        datasets: [{
            // label: "測試值",
            data: [10, 20, 30, 40, 50, 60],
            backgroundColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 3
            
        }]
    },
    options: {        
        scales: {
        }
    }
});
</script>

</div>

</div>

</body>

</html>